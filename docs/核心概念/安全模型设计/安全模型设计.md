# 安全模型设计

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 引言
本文件系统化阐述 OpenClaw 的安全模型设计，覆盖认证与授权、令牌与会话管理、访问控制策略；深入解析沙箱执行模型、权限隔离与资源限制；说明执行审批流程、权限验证与审计日志；解释网络安全协议（TLS）、加密与通信安全；并介绍安全审计机制、违规检测与防护策略，以及安全配置管理、密钥轮换与漏洞修复流程。文档同时提供关键实现路径的“代码片段路径”以便读者定位源码。

## 项目结构
OpenClaw 将安全相关能力分布在多个层次：
- 网关层：认证与授权、TLS 信任策略、反向代理与本地直连判定
- 执行与工具层：工具调用的策略、允许清单、执行审批与主机提升
- 沙箱层：容器隔离、网络与能力限制、工作区挂载策略
- 审计与合规层：文件系统权限、通道安全、模型与插件风险评估
- 配置与凭证：环境变量优先、敏感信息存储与轮换

```mermaid
graph TB
subgraph "网关与通信"
A["Gateway 认证<br/>src/gateway/auth.ts"]
B["Android TLS 信任<br/>apps/android/.../GatewayTls.kt"]
end
subgraph "执行与工具"
C["执行审批与允许清单<br/>src/infra/exec-approvals.ts"]
D["工具策略与沙箱策略<br/>src/agents/sandbox/runtime-status.ts"]
end
subgraph "沙箱与隔离"
E["Docker 沙箱参数<br/>src/agents/sandbox/docker.ts"]
F["沙箱类型定义<br/>src/agents/sandbox/types.docker.ts"]
G["沙箱文档与模式<br/>docs/gateway/sandboxing.md"]
end
subgraph "审计与合规"
H["安全审计主流程<br/>src/security/audit.ts"]
I["审计扩展与风险项<br/>src/security/audit-extra.ts"]
J["Windows ACL 解析<br/>src/security/windows-acl.ts"]
end
subgraph "凭证与认证"
K["认证健康度与过期处理<br/>src/agents/auth-health.ts"]
L["Doctor 认证修复流程<br/>src/commands/doctor-auth.ts"]
M["OAuth 回调与本地服务<br/>extensions/google-gemini-cli-auth/oauth.ts"]
end
A --> C
C --> D
D --> E
E --> F
H --> I
H --> J
A --> B
K --> L
L --> M
```

## 核心组件
- 网关认证与授权
  - 支持基于令牌或密码的认证，支持 Tailscale 身份校验与本地直连判定，严格比较算法避免时序攻击。
  - 参考路径：`src/gateway/auth.ts`
- 执行审批与允许清单
  - 统一的执行安全策略（deny/allowlist/full）与询问策略（off/on-miss/always），支持按代理与通配符合并，提供 socket 通道进行交互式审批。
  - 参考路径：`src/infra/exec-approvals.ts`
- 沙箱执行模型
  - 基于 Docker 的容器隔离，支持只读根文件系统、网络隔离、能力降级、seccomp/AppArmor、资源限制与临时内存等。
  - 参考路径：`src/agents/sandbox/docker.ts`，`src/agents/sandbox/types.docker.ts`，`docs/gateway/sandboxing.md`
- 安全审计
  - 文件系统权限、通道安全、模型与插件风险、钩子与网关配置、浏览器控制等多维度扫描，输出严重性分级与修复建议。
  - 参考路径：`src/security/audit.ts`，`src/security/audit-extra.ts`，`src/security/windows-acl.ts`
- 凭证与认证健康
  - OAuth/Token 存储与健康检查、过期预警与自动刷新、Doctor 修复流程、OAuth 回调本地服务。
  - 参考路径：`src/agents/auth-health.ts`，`src/commands/doctor-auth.ts`，`extensions/google-gemini-cli-auth/oauth.ts`

## 架构总览
下图展示了从客户端到网关、再到沙箱与主机执行的整体安全流：

```mermaid
sequenceDiagram
participant U as "用户/通道"
participant GW as "网关认证<br/>src/gateway/auth.ts"
participant EX as "执行审批<br/>src/infra/exec-approvals.ts"
participant SB as "沙箱运行时<br/>src/agents/sandbox/docker.ts"
participant HM as "主机执行"
U->>GW : "建立连接/发送请求"
GW->>GW : "令牌/密码/Tailscale 校验"
alt "需要执行工具"
GW->>EX : "查询执行策略/允许清单"
EX-->>GW : "返回决策(允许/拒绝/需审批)"
opt "需要交互审批"
GW->>U : "推送审批提示"
U-->>GW : "确认/拒绝"
end
opt "沙箱启用"
GW->>SB : "启动容器/执行命令"
SB-->>HM : "仅在容器内可见的受限环境"
end
opt "主机提升(elevated)"
GW->>HM : "直接在主机执行"
end
else "无需执行工具"
GW-->>U : "正常响应"
end
```

## 详细组件分析

### 认证与授权机制
- 网关认证模式
  - 支持令牌模式与密码模式，可选择允许 Tailscale 身份作为补充认证。
  - 本地直连判定结合 Host 头与代理头，确保本地/隧道访问的正确性。
  - 使用安全相等比较避免时序攻击。
- 通道安全
  - 文档明确指出 Web 控制界面仅限本地使用，不应对公网暴露。
- 参考路径
  - `src/gateway/auth.ts`
  - `docs/gateway/authentication.md`
  - `SECURITY.md`

### 令牌管理与会话控制
- 令牌与密码
  - 网关支持通过配置或环境变量设置令牌/密码，并对短令牌给出告警。
- 设备身份与本地直连
  - 通过 Host 与代理头判断本地直连，避免伪造本地性。
- 参考路径
  - `src/gateway/auth.ts`
  - `src/gateway/auth.ts`

### 访问控制策略与工具策略
- 工具策略三层叠加
  - 全局/按代理/按提供者/沙箱工具策略共同决定可用工具集合。
  - deny 优先，allow 非空时其余默认阻断。
- 沙箱工具策略
  - 仅当启用沙箱时生效，与全局工具策略共同约束。
- 参考路径
  - `docs/gateway/sandboxing.md`
  - `src/agents/sandbox/runtime-status.ts`

### 执行审批流程与权限验证
- 执行安全等级
  - deny/allowlist/full 三档，allowlist 需要匹配允许清单或技能白名单才放行。
- 询问策略
  - off/on-miss/always，结合安全等级与允许清单匹配结果动态决定是否弹窗审批。
- 审批通道
  - 通过本地 socket 传递审批请求，超时与错误处理完善。
- 参考路径
  - `src/infra/exec-approvals.ts`
  - `src/infra/exec-approvals.ts`
  - `src/infra/exec-approvals.ts`

```mermaid
flowchart TD
Start(["开始"]) --> CheckSec["评估执行安全等级"]
CheckSec --> CheckAllow["检查允许清单/技能白名单"]
CheckAllow --> NeedAsk{"是否需要询问?"}
NeedAsk --> |否| Allow["允许执行"]
NeedAsk --> |是| Socket["通过 socket 发起审批"]
Socket --> Decision{"审批结果"}
Decision --> |允许| Allow
Decision --> |拒绝| Deny["拒绝执行"]
Allow --> End(["结束"])
Deny --> End
```

### 沙箱执行模型与权限隔离
- 模式与作用域
  - 模式：off/non-main/all；作用域：session/agent/shared。
- 工作区访问
  - none/ro/rw，分别映射到独立沙箱工作区或只读/读写挂载代理工作区。
- Docker 安全加固
  - 只读根文件系统、无网络、能力降级、seccomp/AppArmor、资源限制、临时内存等。
- 参考路径
  - `docs/gateway/sandboxing.md`
  - `src/agents/sandbox/docker.ts`
  - `src/agents/sandbox/types.docker.ts`

```mermaid
classDiagram
class SandboxDockerConfig {
+string image
+string containerPrefix
+string workdir
+boolean readOnlyRoot
+string[] tmpfs
+string network
+string user
+string[] capDrop
+Record~string,string~ env
+string setupCommand
+number pidsLimit
+string|number memory
+string|number memorySwap
+number cpus
+Record~string,string|number|Ulimit~ ulimits
+string seccompProfile
+string apparmorProfile
+string[] dns
+string[] extraHosts
+string[] binds
}
```

### 网络安全协议与 TLS 加密
- Android 端 TLS 信任策略
  - 支持指纹固定、首次使用（TOFU）存储与回退信任链校验。
- 网关侧认证
  - 本地直连与代理头校验，避免伪造本地性；支持 Tailscale 用户身份校验。
- 参考路径
  - `apps/android/app/src/main/java/ai/openclaw/android/gateway/GatewayTls.kt`
  - `src/gateway/auth.ts`

### 安全审计机制与违规检测
- 审计范围
  - 文件系统权限、通道安全（DM 策略、组策略、允许列表）、模型与插件风险、钩子与网关配置、浏览器控制等。
- 严重性分级
  - info/warn/critical，支持深度探测（如网关连通性）。
- Windows ACL 解析
  - 识别不受信主体与权限，提供重置命令模板。
- 参考路径
  - `src/security/audit.ts`
  - `src/security/audit-extra.ts`
  - `src/security/windows-acl.ts`

### 凭证存储与密钥轮换
- 凭证健康检查
  - OAuth/Token 过期时间计算、即将过期告警、自动刷新逻辑。
- Doctor 修复流程
  - 交互式刷新过期 OAuth 令牌，必要时重新认证静态令牌。
- OAuth 回调
  - 本地 HTTP 服务器接收回调，校验 state/code 并完成授权。
- 参考路径
  - `src/agents/auth-health.ts`
  - `src/commands/doctor-auth.ts`
  - `extensions/google-gemini-cli-auth/oauth.ts`

## 依赖关系分析
- 组件耦合
  - 网关认证依赖环境变量与配置，执行审批依赖策略文件与 socket，沙箱执行依赖 Docker 参数与镜像。
- 外部依赖
  - Docker 引擎、系统 ACL（Windows）、证书信任链（Android/TLS）。
- 审计依赖
  - 文件系统权限检查、通道插件安全接口、浏览器配置解析。

```mermaid
graph LR
AUTH["网关认证<br/>src/gateway/auth.ts"] --> EXAP["执行审批<br/>src/infra/exec-approvals.ts"]
EXAP --> SB["沙箱执行<br/>src/agents/sandbox/docker.ts"]
AUD["安全审计<br/>src/security/audit.ts"] --> WACL["Windows ACL<br/>src/security/windows-acl.ts"]
AUD --> EXTRA["审计扩展<br/>src/security/audit-extra.ts"]
AUTH --> TLS["Android TLS<br/>apps/android/.../GatewayTls.kt"]
AUTH --> DOCAUTH["Doctor 认证<br/>src/commands/doctor-auth.ts"]
DOCAUTH --> OAUTH["OAuth 回调<br/>extensions/google-gemini-cli-auth/oauth.ts"]
```

## 性能考量
- 沙箱启动成本
  - 容器创建与初始化存在开销，建议在共享作用域（agent/shared）减少重复创建。
- 执行审批延迟
  - 交互式审批会阻塞工具执行，应合理配置询问策略以平衡安全与效率。
- 审计扫描
  - 深度探测与文件系统遍历可能较耗时，建议按需启用并设置超时。

## 故障排查指南
- 网关绑定与认证
  - 若对外暴露且未配置认证，将被标记为高危；请设置令牌或密码，或仅绑定本地回环。
  - 参考路径：`src/security/audit.ts`
- 执行被拒绝
  - 检查工具策略与沙箱策略；使用“沙箱解释”命令查看生效策略与修复建议。
  - 参考路径：`src/commands/sandbox-explain.ts`，`docs/gateway/sandboxing.md`
- 凭证问题
  - 使用 Doctor 自动刷新过期 OAuth；若为静态令牌需重新认证。
  - 参考路径：`src/commands/doctor-auth.ts`
- Windows 权限
  - 使用 ACL 解析与重置命令修复不受信主体权限。
  - 参考路径：`src/security/windows-acl.ts`

## 结论
OpenClaw 的安全模型以“最小权限+分层隔离”为核心：网关认证与授权确保入口安全；工具策略与执行审批在运行前进行二次把关；沙箱提供强隔离边界；安全审计持续发现配置与策略风险；凭证健康与轮换保障长期可用性。通过上述机制，系统在功能开放与安全可控之间取得平衡，并提供了完善的可观测与修复手段。

## 附录
- 安全配置清单
  - 网关绑定仅回环或启用认证；通道 DM 策略与允许列表；工具策略与沙箱策略；钩子与浏览器控制；模型与插件风险评估。
  - 参考路径：`src/security/audit.ts`，`src/security/audit-extra.ts`
- 漏洞修复流程
  - 使用安全审计生成报告，按严重性逐项修复；更新 Node.js 至受支持版本；Docker 运行时采用只读与能力降级。
  - 参考路径：`SECURITY.md`