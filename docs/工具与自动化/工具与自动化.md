# 工具与自动化

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考量](#性能考量)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本文件面向 OpenClaw 的工具与自动化系统，聚焦以下主题：
- 浏览器控制工具与 Chrome/Chromium 集成、CDP 控制机制
- Canvas 渲染系统、A2UI 主机与可视化工作区管理
- 节点操作工具：相机控制、屏幕录制、位置获取、通知系统
- 定时任务系统、Cron 作业调度与唤醒机制
- 自动化工作流程、技能系统与任务编排
- 工具开发指南：自定义工具创建、权限管理与安全考虑
- 性能优化建议、故障排除与最佳实践
- 实际工具配置示例与使用场景

## 项目结构
OpenClaw 采用多语言混合架构，核心逻辑位于 src，平台适配在 apps，浏览器扩展在 assets/chrome-extension，技能与工作流在 skills，文档在 docs。

```mermaid
graph TB
subgraph "浏览器与CDP"
CDP["CDP 控制层<br/>src/browser/*"]
Exec["可执行解析<br/>src/browser/chrome.executables.ts"]
Ext["Chrome 扩展<br/>assets/chrome-extension/*"]
end
subgraph "Canvas 与 A2UI"
CanvasHost["Canvas 主机<br/>src/canvas-host/server.ts"]
A2UI["A2UI 路由与资源<br/>src/canvas-host/a2ui.ts"]
A2UIWeb["A2UI 前端组件<br/>apps/shared/OpenClawKit/Tools/CanvasA2UI/bootstrap.js"]
end
subgraph "节点与设备"
NodesTool["节点工具集<br/>src/agents/tools/nodes-tool.ts"]
IOS["iOS 屏幕与相机桥接<br/>apps/ios/Sources/Model/NodeAppModel.swift"]
end
subgraph "自动化与调度"
CronSvc["Cron 服务封装<br/>src/cron/service.ts"]
CronTimer["唤醒与计时器<br/>src/cron/service/timer.ts"]
end
subgraph "权限与策略"
Policy["工具策略与分组<br/>src/agents/tool-policy.ts"]
Sandbox["沙箱工具策略<br/>src/agents/sandbox/tool-policy.ts"]
Elevated["提升权限校验<br/>src/auto-reply/reply-elevated.ts"]
GatewayHTTP["工具调用 HTTP 入口<br/>src/gateway/tools-invoke-http.ts"]
end
CDP --> Exec
CDP --> Ext
CanvasHost --> A2UI
A2UI --> A2UIWeb
NodesTool --> IOS
CronSvc --> CronTimer
Policy --> Sandbox
Policy --> Elevated
Policy --> GatewayHTTP
```

## 核心组件
- 浏览器控制与 CDP
  - 通过路由与配置实现浏览器状态查询、CDP 可达性检测与基本操作入口。
  - 可执行解析模块自动发现并选择 Chrome/Chromium/Edge/Brave 等浏览器可执行文件。
  - Chrome 扩展提供本地 CDP 中继，便于将现有标签页接入 OpenClaw。
- Canvas 与 A2UI
  - Canvas 主机提供静态资源与热重载能力；A2UI 路由负责 A2UI 资源与消息处理。
  - iOS/Android 侧通过 WebView 桥接与 Canvas 交互，支持用户动作与系统通知。
- 节点工具集
  - 统一的节点工具接口，支持状态查询、描述、配对审批、相机抓拍/录制、屏幕录制、位置获取、系统运行与通用 `invoke`。
- 定时任务与唤醒
  - Cron 服务封装与计时器逻辑，支持“立即唤醒”和“下一次心跳”两种唤醒模式。
- 权限与策略
  - 工具策略与分组、沙箱策略、提升权限校验与 HTTP 工具调用入口，确保最小授权与安全边界。

## 架构总览
OpenClaw 的工具与自动化围绕“浏览器-Canvas-A2UI-节点-调度-权限”六大维度协同工作。浏览器通过 CDP 与本地/远程 Chrome 集成；Canvas/A2UI 提供可视化工作区；节点工具集连接物理设备与系统能力；Cron 负责周期性与即时唤醒；权限体系贯穿策略与调用链路。

```mermaid
graph TB
Browser["浏览器/CDP<br/>routes/basic.ts + chrome.executables.ts"]
Ext["Chrome 扩展<br/>manifest.json"]
Canvas["Canvas 主机<br/>server.ts"]
A2UI["A2UI 路由<br/>a2ui.ts"]
UI["A2UI 前端组件<br/>bootstrap.js"]
Nodes["节点工具集<br/>nodes-tool.ts"]
IOS["iOS 屏幕/相机桥接<br/>NodeAppModel.swift"]
Cron["Cron 服务<br/>service.ts"]
Timer["唤醒计时器<br/>timer.ts"]
Policy["工具策略<br/>tool-policy.ts"]
Sandbox["沙箱策略<br/>sandbox/tool-policy.ts"]
Elevated["提升权限<br/>auto-reply/reply-elevated.ts"]
Gateway["工具调用入口<br/>gateway/tools-invoke-http.ts"]
Browser --> Ext
Browser --> Canvas
Canvas --> A2UI
A2UI --> UI
Nodes --> IOS
Cron --> Timer
Policy --> Sandbox
Policy --> Elevated
Policy --> Gateway
```

## 详细组件分析

### 浏览器控制与 CDP 集成
- 路由与状态
  - 基础路由提供“列出配置文件”“获取状态（含 CDP 可达性）”等接口，结合配置上下文与档案上下文进行状态判断。
- 可执行解析
  - 跨平台解析默认 Chromium 系列可执行文件，支持 macOS/Linux/Windows，自动识别 Brave、Chrome、Edge、Chromium、Opera、Vivaldi、Yandex 等。
- Chrome 扩展
  - Manifest 声明 debugger、tabs、activeTab、storage 权限与本地 CDP 中继能力，支持点击附加/分离目标标签页。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Routes as "浏览器路由<br/>routes/basic.ts"
participant Profiles as "档案服务"
participant Ctx as "状态上下文"
participant CDP as "CDP 可达性"
Client->>Routes : GET / 或 /profiles
Routes->>Profiles : 列出配置文件
Profiles-->>Routes : 返回 profiles
Routes->>Ctx : 获取状态
Ctx-->>Routes : 当前状态
Routes->>CDP : 检测 HTTP/WebSocket 可达性
CDP-->>Routes : 结果
Routes-->>Client : JSON 响应
```

### Canvas 渲染系统与 A2UI 主机
- Canvas 主机
  - 提供静态资源服务、路径规范化、安全打开文件、MIME 推断、热重载（WebSocket）与错误日志记录。
- A2UI 路由
  - 解析 A2UI 资源根目录候选，注入 live-reload HTML，处理 A2UI 请求。
- A2UI 前端
  - 组件渲染、状态提示、Toast 通知、表面同步与动作处理，支持空闲等待与工作态反馈。
- iOS/Android 桥接
  - iOS 侧通过 WebView 导航与 ready 状态检测，触发 A2UI 主机访问；提供深链与 A2UI 动作回调。

```mermaid
sequenceDiagram
participant UI as "A2UI 前端<br/>bootstrap.js"
participant Host as "Canvas 主机<br/>server.ts"
participant A2UI as "A2UI 路由<br/>a2ui.ts"
participant IOS as "iOS 屏幕控制器<br/>ScreenController.swift"
participant Model as "NodeAppModel.swift"
Host->>A2UI : 处理 A2UI 请求
A2UI-->>Host : 返回 A2UI 资源
UI->>Host : 访问 Canvas 路径
Host-->>UI : HTML/资源
Model->>Model : 解析 A2UI 主机 URL
Model->>IOS : 导航到 A2UI URL
IOS-->>Model : 等待 A2UI Ready
UI-->>IOS : 触发 A2UI 动作回调
```

### 节点操作工具：相机、屏幕录制、位置与通知
- 工具能力
  - 状态/描述/待处理/批准/拒绝：节点生命周期管理。
  - 通知：标题/正文/声音/优先级/投递方式。
  - 相机：抓拍（front/back/both）、列表、录制（front/back）。
  - 屏幕录制：帧率、屏幕索引、音频开关、输出路径。
  - 位置：最大年龄、精度、超时。
  - 系统运行：命令、工作目录、环境变量、超时、是否需要屏幕录制。
  - 通用 `invoke`：自定义命令与参数。
- iOS 屏幕录制桥接
  - 通过 ScreenRecordService 录制 MP4，返回 base64 数据并编码为 JSON payload。

```mermaid
flowchart TD
Start(["节点工具入口"]) --> Action{"动作类型"}
Action --> |notify| Notify["发送系统通知"]
Action --> |camera_snap| CamSnap["相机抓拍<br/>front/back/both"]
Action --> |camera_clip| CamClip["相机录制<br/>front/back"]
Action --> |screen_record| ScrRec["屏幕录制<br/>MP4"]
Action --> |location_get| LocGet["获取位置<br/>精度/超时"]
Action --> |run| SysRun["系统运行<br/>命令/环境/超时"]
Action --> |invoke| Invoke["通用 invoke<br/>命令+参数"]
Notify --> End(["返回结果"])
CamSnap --> End
CamClip --> End
ScrRec --> End
LocGet --> End
SysRun --> End
Invoke --> End
```

### 定时任务系统、Cron 调度与唤醒
- Cron 服务封装
  - 提供 start/stop/status/list/add/update/remove/run/wake 等方法。
- 唤醒机制
  - 支持“立即唤醒”和“下一次心跳”两种模式；当系统事件文本为空时会跳过并记录警告；单次任务运行后可自动禁用。
- 调试与验证
  - 单元测试覆盖了“空事件文本跳过”“下一唤醒时间报告”“立即唤醒等待心跳完成”等行为。

```mermaid
sequenceDiagram
participant Agent as "Agent"
participant Cron as "Cron 服务<br/>service.ts"
participant Timer as "计时器<br/>timer.ts"
participant Heartbeat as "心跳请求"
Agent->>Cron : wake({mode,text})
Cron->>Timer : enqueueSystemEvent(text)
alt mode == "now"
Timer->>Heartbeat : requestHeartbeatNow(reason)
else mode == "next-heartbeat"
Note right of Timer : 等待下次心跳
end
Timer-->>Cron : emit(event)
```

### 权限与安全：策略、沙箱与提升权限
- 工具策略与分组
  - 定义工具分组（如 `group:fs`、`group:runtime`、`group:nodes`），支持配置文件与代理工具的策略展开与未知条目剥离。
- 沙箱策略
  - 基于全局/代理/插件/组等多层级策略合并与过滤，最终确定可用工具集合。
- 提升权限
  - 对“提升工具”进行全局与代理级开关校验，缺失 provider 时拒绝。
- 工具调用入口
  - HTTP 入口按策略逐层过滤工具，找不到工具时返回 404。

```mermaid
flowchart TD
Req["HTTP 请求"] --> Global["全局策略"]
Global --> Provider["Provider 策略"]
Provider --> Agent["Agent 策略"]
Agent --> Group["组/插件策略"]
Group --> Filter["过滤可用工具"]
Filter --> Tool["匹配工具名"]
Tool --> |存在| Exec["执行工具"]
Tool --> |不存在| NotFound["404 Not Found"]
```

### 工具开发指南：自定义工具与技能
- 自定义工具
  - 使用 CLI 子命令设置浏览器凭据（支持 clear、`targetId` 等参数），通过 `/set/credentials` 路由下发至 CDP 目标。
- 技能系统
  - 技能是包含 SKILL.md 的目录，可通过前端刷新或重启网关发现新技能；建议遵循“简洁指令、安全优先、本地测试”的最佳实践。
- 使用场景
  - 通过节点工具进行相机抓拍/录制、屏幕录制、位置获取与系统运行；通过 Cron 定时触发任务；通过 A2UI 构建可视化工作区。

## 依赖关系分析
- 组件耦合
  - 浏览器路由依赖配置与档案上下文；CDP 可达性检测影响状态返回。
  - Canvas 主机依赖 A2UI 路由与前端组件；iOS 侧依赖 Canvas 主机可达性。
  - 节点工具依赖网关工具调用；iOS 侧提供录制与媒体回传。
  - Cron 服务依赖计时器与心跳请求；策略体系贯穿工具调用入口。
- 外部依赖
  - Chrome/Chromium/Edge/Brave 可执行文件解析；WebSocket 热重载；HTTP 工具调用。

```mermaid
graph LR
Routes["routes/basic.ts"] --> Types["types.browser.ts"]
Routes --> Exec["chrome.executables.ts"]
Exec --> Ext["chrome-extension/manifest.json"]
Canvas["canvas-host/server.ts"] --> A2UI["canvas-host/a2ui.ts"]
A2UI --> UI["CanvasA2UI/bootstrap.js"]
Nodes["agents/tools/nodes-tool.ts"] --> IOS["ios/NodeAppModel.swift"]
Cron["cron/service.ts"] --> Timer["cron/service/timer.ts"]
Policy["agents/tool-policy.ts"] --> Sandbox["agents/sandbox/tool-policy.ts"]
Policy --> Elevated["auto-reply/reply-elevated.ts"]
Policy --> Gateway["gateway/tools-invoke-http.ts"]
```

## 性能考量
- 浏览器与 CDP
  - 优先使用本地 CDP，避免远程延迟；合理设置超时与握手超时；在容器环境启用无沙箱选项时注意安全边界。
- Canvas 与 A2UI
  - 启用热重载时注意文件监视开销，必要时降低监听范围或关闭热重载；HTML 注入 live-reload 仅在开发环境启用。
- 节点工具
  - 相机/录制/屏幕录制涉及 I/O 与编解码，建议限制分辨率与帧率；对大文件输出使用临时路径并及时清理。
- Cron
  - 避免过于频繁的心跳；单次任务完成后自动禁用减少无效调度；对空事件文本进行早返回以节省资源。

## 故障排除指南
- 浏览器状态异常
  - 检查 CDP 可达性与 profile 状态；确认浏览器可执行文件路径正确；查看扩展权限与本地端口占用。
- Canvas/A2UI 无法加载
  - 确认 Canvas 主机已启动且根目录存在 index.html；检查热重载 WebSocket 升级；验证 A2UI 路径与资源存在。
- iOS 屏幕录制失败
  - 确认 A2UI 主机 URL 已配置且可达；等待 A2UI Ready；检查录制参数（格式/帧率/音频）与输出路径。
- Cron 任务未触发
  - 确认 cron 已启用且 Gateway 常驻；检查时区与系统时间；使用调试命令查看运行历史；关注空事件文本导致的跳过行为。
- 工具调用 404
  - 检查策略允许列表与分组展开；确认工具名称大小写与别名映射；核对插件工具归属与组名。

## 结论
OpenClaw 的工具与自动化体系以浏览器 CDP、Canvas/A2UI、节点工具集、Cron 调度与权限策略为核心，形成从可视化工作区到设备控制与任务编排的完整闭环。通过合理的配置、策略与安全约束，可在多平台上稳定运行并扩展新的工具与技能。

## 附录
- 实际使用场景示例
  - 浏览器登录与凭据设置：通过 CLI 子命令设置 HTTP 基本认证凭据并下发至指定 CDP 目标。
  - 可视化工作区：在 Canvas 主机根目录放置页面，A2UI 注入 live-reload 并通过 iOS/Android WebView 交互。
  - 节点自动化：定时任务触发节点相机抓拍/录制、屏幕录制与位置获取，结果以文件或媒体形式返回。
  - 技能开发：在工作区创建 SKILL.md，定义工具与指令，重启网关后即可被智能体使用。